<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calculadora Científica — SCI</title>
<style>
  :root{
    --bg:#0b0b0d; --panel:#16171a; --key:#222327; --key2:#2b2c31; --accent:#ff8a1d; --txt:#e9e9ee; --muted:#a7a9b2;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:500 16px/1.2 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:420px;margin:24px auto;padding:16px}
  .calc{background:var(--panel);border-radius:24px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
  .display{
    height:110px;border-radius:18px;background:#0f1013;display:flex;flex-direction:column;justify-content:center;
    padding:12px 16px; text-align:right; overflow:hidden
  }
  .topline{font-size:14px;color:var(--muted);min-height:18px;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .mainline{font-size:42px;font-weight:700; letter-spacing:.5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .mode-indicator{font-size:14px;color:var(--accent);margin-top:4px}
  .row{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:12px}
  button{
    appearance:none;border:0;border-radius:16px;padding:14px 10px; background:var(--key); color:var(--txt);
    font-weight:600;font-size:16px; cursor:pointer; transition:.12s transform ease, .12s background ease;
    user-select:none; -webkit-tap-highlight-color:transparent
  }
  button:active{transform:translateY(1px)}
  button.fn{background:var(--key2)}
  button.op{color:var(--accent)}
  button.equal{
    background:var(--accent); 
    color:#111; 
    font-size:18px;
  }
  .toggle{display:flex;gap:8px;margin-top:10px}
  .pill{flex:1;background:var(--key2);padding:8px;border-radius:999px;display:flex;justify-content:space-between;align-items:center}
  .pill span{font-size:12px;color:var(--muted)}
  .switch{background:#0f1013;width:44px;height:26px;border-radius:999px;position:relative}
  .knob{position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;transition:.15s}
  .on .knob{left:21px;background:var(--accent)}
  .foot{margin-top:10px;color:var(--muted);font-size:12px;text-align:center}
  @media (max-width:420px){
    .mainline{font-size:38px}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="calc" id="calc">
    <div class="display" id="display">
      <div class="topline" id="history"></div>
      <div class="mainline" id="output">0</div>
      <div class="mode-indicator" id="modeText">DEG</div>
    </div>

    <div class="toggle">
      <div class="pill" id="degRad">
        <span>DEG / RAD</span>
        <div class="switch"><div class="knob"></div></div>
      </div>
      <div class="pill" id="sciMode">
        <span>SCI Display</span>
        <div class="switch"><div class="knob"></div></div>
      </div>
    </div>

    <!-- fila 1 -->
    <div class="row">
      <button class="fn" data-act="2nd">2nd</button>
      <button class="fn" data-insert="rad" disabled>rad</button>
      <button class="fn" data-fn="sin">sin</button>
      <button class="fn" data-fn="cos">cos</button>
      <button class="fn" data-fn="tan">tan</button>
    </div>
    <!-- fila 2 -->
    <div class="row">
      <button class="fn" data-op="pow">x^y</button>
      <button class="fn" data-fn="log10">lg</button>
      <button class="fn" data-fn="ln">ln</button>
      <button class="fn" data-insert="(">(</button>
      <button class="fn" data-insert=")">)</button>
    </div>
    <!-- fila 3 -->
    <div class="row">
      <button class="fn" data-fn="sqrt">√x</button>
      <button class="fn" data-act="AC" style="color:var(--accent)">AC</button>
      <button class="fn" data-act="DEL">⌫</button>
      <button class="fn" data-fn="percent">%</button>
      <button class="op" data-insert="÷">÷</button>
    </div>
    <!-- fila 4 -->
    <div class="row">
      <button class="fn" data-fn="fact">x!</button>
      <button data-insert="7">7</button>
      <button data-insert="8">8</button>
      <button data-insert="9">9</button>
      <button class="op" data-insert="×">×</button>
    </div>
    <!-- fila 5 -->
    <div class="row">
      <button class="fn" data-fn="inv">1/x</button>
      <button data-insert="4">4</button>
      <button data-insert="5">5</button>
      <button data-insert="6">6</button>
      <button class="op" data-insert="-">−</button>
    </div>
    <!-- fila 6 -->
    <div class="row">
      <button class="fn" data-insert="π">π</button>
      <button data-insert="1">1</button>
      <button data-insert="2">2</button>
      <button data-insert="3">3</button>
      <button class="op" data-insert="+">+</button>
    </div>
    <!-- fila 7 corregida -->
    <div class="row">
      <button class="fn" data-insert="𝑒">e</button>
      <button data-insert="0">0</button>
      <button data-insert=".">.</button>
      <button class="fn" data-act="EXP">EXP</button>
      <button class="equal" data-act="=">=</button>
    </div>
    <div class="foot">EXP inserta notación científica (ej. 3.2 EXP -5 → 3.2e-5). Modo SCI muestra resultados en forma exponencial.</div>
  </div>
</div>

<script>
(() => {
  const out = document.getElementById('output');
  const hist = document.getElementById('history');
  const degRad = document.getElementById('degRad');
  const sciMode = document.getElementById('sciMode');
  const modeText = document.getElementById('modeText');

  let radians = false;
  let sciDisplay = false;
  let expr = "";
  let justEvaluated = false;
  let expPending = false;

  const toggle = (el, flag) => { el.querySelector('.switch').classList.toggle('on', flag); };
  const updateModeText = () => { modeText.textContent = radians ? "RAD" : "DEG"; };

  toggle(degRad, radians);
  toggle(sciMode, sciDisplay);
  updateModeText();

  degRad.addEventListener('click', () => { radians = !radians; toggle(degRad, radians); updateModeText(); });
  sciMode.addEventListener('click', () => { sciDisplay = !sciDisplay; toggle(sciMode, sciDisplay); redraw(); });

  const clip = n => (Math.abs(n) === Infinity || Number.isNaN(n)) ? NaN : n;

  function factorial(n){
    if(!Number.isFinite(n) || n < 0 || n % 1 !== 0) return NaN;
    if(n>170) return Infinity;
    let r=1; for(let i=2;i<=n;i++) r*=i; return r;
  }

  function percent(x){ return x/100; }

  function insert(txt){
    if(justEvaluated && /[0-9.π𝑒]/.test(txt)) { expr = ""; hist.textContent = ""; }
    justEvaluated = false;

    if(expPending){
      if(/^[+\-]?\d?\.?\d*$/.test(expr) || /[0-9)]$/.test(expr)){
        expr += (txt === '-' ? 'e-' : 'e');
      }else{
        expr += 'e';
      }
      expPending = false;
      redraw();
      if(txt && txt !== '-') insert(txt);
      return;
    }

    if(txt==='÷') txt='/';
    if(txt==='×') txt='*';
    if(txt==='π') txt='π';
    if(txt==='𝑒') txt='𝑒';

    expr += txt;
    redraw();
  }

  function redraw(value=null){
    out.textContent = value !== null ? format(value) : pretty(expr) || "0";
  }

  function pretty(s){
    return s.replace(/\//g,'÷').replace(/\*/g,'×');
  }

  function format(n){
    if(typeof n!=='number' || !Number.isFinite(n)) return 'Error';
    if(sciDisplay && n!==0){
      return n.toExponential(8).replace('e','×10^');
    }
    let str = (Math.abs(n) >= 1e12 || (Math.abs(n) < 1e-6 && n!==0)) ? n.toExponential(8) : String(n);
    if(str.includes('e')) return str;
    if(str.includes('.')){
      str = str.replace(/(\.\d*?[1-9])0+$/,'$1').replace(/\.0+$/,'');
    }
    return str;
  }

  function toJS(s){
    if(/[^0-9+\-*/()., eπ𝑒^%!]/i.test(s)) return null;

    let js = s;
    js = js.replace(/(\d+(?:\.\d+)?|\([^()]+\))%/g, 'percent($1)');
    js = js.replace(/([0-9π𝑒.]+|\([^()]*\))\^([0-9π𝑒.]+|\([^()]*\))/g, 'Math.pow($1,$2)');
    js = js.replace(/π/g, 'Math.PI');
    js = js.replace(/𝑒/g, 'Math.E');
    js = js.replace(/\bln\(/g,'Math.log(');
    js = js.replace(/\blog10\(/g,'Math.log10(');
    js = js.replace(/\bsqrt\(/g,'Math.sqrt(');

    const trigWrap = f => `((${radians})?Math.${f}(%ARG%):Math.${f}(%ARG%*Math.PI/180))`;
    js = js.replace(/\bsin\(([^()]+)\)/g, (_,a)=>trigWrap('sin').replace('%ARG%',a));
    js = js.replace(/\bcos\(([^()]+)\)/g, (_,a)=>trigWrap('cos').replace('%ARG%',a));
    js = js.replace(/\btan\(([^()]+)\)/g, (_,a)=>trigWrap('tan').replace('%ARG%',a));

    js = js.replace(/(\d+(?:\.\d+)?|\([^()]*\))!/g,'factorial($1)');
    js = js.replace(/\binv\(([^()]+)\)/g,'(1/($1))');

    return js;
  }

  function evaluate(){
    if(!expr) return;
    const js = toJS(expr);
    if(js === null) { out.textContent = 'Error'; return; }
    try{
      const val = clip(Function('factorial','percent',`"use strict"; return (${js});`)(factorial,percent));
      redraw(val);
      hist.textContent = pretty(expr)+' =';
      expr = String(val);
      justEvaluated = true;
    }catch(e){
      out.textContent = 'Error';
      justEvaluated = false;
    }
  }

  function handleAction(act){
    switch(act){
      case 'AC': expr=""; hist.textContent=""; justEvaluated=false; expPending=false; redraw(); break;
      case 'DEL':
        if(justEvaluated){ expr=""; hist.textContent=""; justEvaluated=false; }
        else expr = expr.slice(0,-1);
        redraw(); break;
      case '=': evaluate(); break;
      case 'EXP':
        expPending = true;
        if(!expr || /[+\-*/(]$/.test(expr)) expr += '0';
        redraw();
        break;
      default: break;
    }
  }

  function handleFn(name){
    if(justEvaluated && ['sin','cos','tan','ln','log10','sqrt','inv','percent'].includes(name)){
      expr = name+'('+expr+')';
      justEvaluated=false;
      redraw();
      return;
    }

    switch(name){
      case 'sqrt': expr += 'sqrt('; break;
      case 'ln': expr += 'ln('; break;
      case 'log10': expr += 'log10('; break;
      case 'sin': expr += 'sin('; break;
      case 'cos': expr += 'cos('; break;
      case 'tan': expr += 'tan('; break;
      case 'inv': expr += 'inv('; break;
      case 'fact':
        if(expr && /[0-9)𝑒π]$/.test(expr)) expr += '!';
        break;
      case 'percent':
        if(expr && /[0-9)]$/.test(expr)) expr += '%';
        break;
      default: break;
    }
    redraw();
  }

  function handleOp(op){
    if(op==='pow'){
      if(!expr) expr='0';
      expr += '^';
      redraw();
    }
  }

  document.getElementById('calc').addEventListener('click', (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    const ins = b.dataset.insert, fn = b.dataset.fn, act = b.dataset.act, op = b.dataset.op;
    if(ins!=null) insert(ins);
    else if(fn) handleFn(fn);
    else if(act) handleAction(act);
    else if(op) handleOp(op);
  });

  window.addEventListener('keydown', (e)=>{
    const k = e.key;
    if(/[0-9]/.test(k)) insert(k);
    else if(k==='+') insert('+');
    else if(k==='-') insert('-');
    else if(k==='*') insert('×');
    else if(k==='/') insert('÷');
    else if(k==='(' || k===')' || k==='.') insert(k);
    else if(k==='Backspace') handleAction('DEL');
    else if(k==='Enter' || k==='=') handleAction('=');
    else if(k.toLowerCase()==='e' && e.altKey) handleAction('EXP');
  });

})();
</script>
</body>
</html>